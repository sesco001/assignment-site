<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Assignment Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans">

<!-- Navbar -->
<nav class="bg-blue-900 text-white p-4 flex justify-between">
  <h1 class="text-xl font-bold">ðŸ“˜ Assignment Pro - Admin</h1>
  <button id="logoutBtn" class="px-3 py-2 bg-red-500 font-semibold rounded-lg">Logout</button>
</nav>

<section class="max-w-6xl mx-auto py-10 px-4">
  <h2 class="text-3xl font-bold mb-6">All Assignments</h2>

  <table class="w-full text-left border-collapse">
    <thead>
      <tr>
        <th class="border p-2">Title</th>
        <th class="border p-2">User Email</th>
        <th class="border p-2">Status</th>
        <th class="border p-2">Paid</th>
        <th class="border p-2">Solution</th>
        <th class="border p-2">Actions</th>
      </tr>
    </thead>
    <tbody id="adminAssignments"></tbody>
  </table>
</section>

<script>
const admin = JSON.parse(localStorage.getItem("user"));
if(!admin || admin.role !== "admin") window.location.href = "login.html";

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("user");
  window.location.href = "login.html";
});

// Load assignments
async function loadAdminAssignments(){
  const res = await fetch("https://superbase.onrender.com/api/admin/assignments");
  const assignments = await res.json();
  const tbody = document.getElementById("adminAssignments");
  tbody.innerHTML = "";
  assignments.forEach(a => {
    tbody.innerHTML += `
      <tr>
        <td class="border p-2">${a.title}</td>
        <td class="border p-2">${a.email}</td>
        <td class="border p-2">${a.status}</td>
        <td class="border p-2">${a.paid ? "Yes" : "No"}</td>
        <td class="border p-2">${a.solution ? `<a href="${a.solution.link || a.solution.file_url}" target="_blank">View</a>` : "N/A"}</td>
        <td class="border p-2">
          ${!a.paid ? `<button onclick="markPaid('${a.id}')" class="bg-green-500 text-white px-2 py-1 rounded mb-1">Mark Paid</button>` : ""}
          <form onsubmit="uploadSolution(event,'${a.id}')" class="mt-1">
            <input type="file" name="solution" required>
            <button type="submit" class="bg-blue-500 text-white px-2 py-1 rounded">Upload Solution</button>
          </form>
        </td>
      </tr>`;
  });
}

// Mark paid
async function markPaid(id){
  const res = await fetch("https://superbase.onrender.com/api/admin/mark-paid", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  });
  const data = await res.json();
  alert(data.message);
  loadAdminAssignments();
}

// Upload solution
async function uploadSolution(e, id){
  e.preventDefault();
  const file = e.target.solution.files[0];
  const formData = new FormData();
  formData.append("id", id);
  formData.append("file", file);

  const res = await fetch("https://superbase.onrender.com/api/admin/upload-solution", {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  alert(data.message);
  loadAdminAssignments();
}

loadAdminAssignments();
</script>

</body>
</html>
